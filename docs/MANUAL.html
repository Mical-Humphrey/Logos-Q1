<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Logos-Q1 Manual</title>
<style>
:root{--bg:#0f172a;--fg:#e5e7eb;--accent:#93c5fd;--muted:#94a3b8;--card:#111827;--border:#1f2937}
body{background:var(--bg);color:var(--fg);font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0}
.shell{max-width:960px;margin:auto;padding:40px 24px}
h1,h2,h3{color:var(--accent)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin:14px 0}
code{background:#0b1220;padding:2px 6px;border-radius:6px;color:#e5e7eb}
details{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:10px}
details summary{cursor:pointer;color:var(--accent);font-weight:600}
.note{border-left:3px solid var(--accent);padding:6px 10px;background:#0b1220;border-radius:8px}
hr{border:none;border-top:1px solid var(--border);margin:28px 0}
</style>
</head>
<body>
<!-- 🧭 Global Navbar -->
<nav class="nav">
  <div class="nav-left">
    <a href="index.html" class="brand">Logos-Q1</a>
  </div>
  <div class="nav-links">
    <a href="MATH.html">Math</a>
    <a href="FINANCE.html">Finance</a>
    <a href="MANUAL.html">Manual</a>
    <a href="SYSTEM_DESIGN.html">System</a>
  </div>
</nav>

<style>
  .nav {
    position: sticky;
    top: 0;
    z-index: 999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0b1220;
    border-bottom: 1px solid #1f2937;
    padding: 10px 20px;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }
  .nav a {
    color: #e5e7eb;
    text-decoration: none;
    margin-right: 18px;
    font-size: 15px;
  }
  .nav a:hover { color: #93c5fd; }
  .brand {
    font-weight: 700;
    color: #93c5fd !important;
    letter-spacing: 0.4px;
    font-size: 16px;
  }
  .nav-links {
    display: flex;
    gap: 10px;
  }
</style>

<div class="shell">
<h1>🧭 Logos-Q1 Manual</h1>
<p class="note">This guide explains how to install, configure, run, and interpret Logos-Q1 — both as an <b>education lab</b> and a <b>professional backtesting system</b>.</p>

<hr/>
<h2>1) Installation & Setup</h2>
<div class="card">
<p><b>Requirements:</b> Python ≥3.11, pip, Git, modern browser.</p>
<pre><code>git clone https://github.com/Mical-Humphrey/Logos-Q1
cd Logos-Q1
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
</code></pre>
<p>Run tests: <code>pytest</code> — ensures math & finance modules pass baseline checks.</p>
</div>

<h2>2) Launching the Web Docs</h2>
<div class="card">
<p>Simply open <code>docs/index.html</code> in any browser to view your documentation suite.
Each module (Math, Finance, Manual, System Design) is self-contained and styled consistently.</p>
</div>

<h2>3) Running Backtests</h2>
<div class="card">
<p>Example command:</p>
<pre><code>python -m logos.cli backtest --symbol TSLA --strategy momentum --asset-class equity --window P365D --tz America/New_York --paper</code></pre>
<ul>
  <li>Provide either <code>--start</code>/<code>--end</code> (YYYY-MM-DD) or a single <code>--window</code> ISO-8601 duration (e.g. <code>P90D</code>). Mixing the two will become invalid once the validator is wired.</li>
  <li>Use <code>--tz</code> to interpret date inputs in a specific timezone (default: <code>UTC</code>). ISO timestamps with offsets are respected.</li>
  <li>Pass <code>--allow-env-dates</code> if you intentionally want to fall back to <code>.env</code> <code>START_DATE</code>/<code>END_DATE</code>. The CLI will log when this legacy path is used.</li>
  <li>Synthetic fixtures are blocked unless you pass <code>--allow-synthetic</code>; without it the CLI aborts with a clear error before writing artifacts. When you enable the flag the run is tagged as synthetic everywhere (metrics, provenance, session markdown).</li>
  <li>If neither option is supplied the CLI exits early (code 2) with a remediation hint, and it does so before any run directories or downloads are created.</li>
  <li>Use <code>--asset-class</code> to switch between <code>equity</code>, <code>crypto</code>, or <code>forex</code>.</li>
  <li>Add <code>--paper</code> to simulate fills without touching a broker.</li>
  <li>Results stored in <code>runs/</code> (CSV trade log + PNG equity curve).</li>
</ul>
<div class="note">
  <b>Window primer:</b> Logos promotes windows to a first-class type, normalizing all inputs to UTC and enforcing <code>[start, end)</code> semantics (inclusive start, exclusive end). Provide exactly one source (`--window` or `--start/--end`); the CLI rejects mixed inputs before any artifacts are created.
</div>
<ul>
  <li><b>UTC conversion example:</b> launching <code>--window P5D</code> on <code>2024-03-30</code> with <code>--tz America/New_York</code> yields <code>start=2024-03-25T00:00:00+00:00</code>, <code>end=2024-03-30T00:00:00+00:00</code>.</li>
  <li><b>Tz-aware bounds:</b> <code>--start 2024-06-01T09:30:00-04:00 --end 2024-06-05T16:00:00-04:00</code> normalizes to <code>2024-06-01T13:30:00+00:00 → 2024-06-05T20:00:00+00:00</code>.</li>
  <li><b>DST & month-end:</b> the validator works in UTC, so daylight shifts or leap-day spans simply affect the number of bars fetched, not the normalized bounds; provenance files capture the original timezone label for audits.</li>
</ul>
</div>

<h3>Indexing Contract</h3>
<div class="card">
<ul>
  <li>Use <code>.iloc</code> for positional math (rolling windows, warm-up loops). Reserve <code>.loc</code> for label-based access with <code>pandas.Timestamp</code> keys on <code>DatetimeIndex</code> frames.</li>
  <li>Ensure OHLCV frames, signals, and artifacts retain tz-aware <code>DatetimeIndex</code>; avoid object dtypes for timestamps so provenance and window checks remain deterministic.</li>
  <li>Regression fixtures and <code>metrics.json</code> embed the resolved window bounds alongside the seed and timezone label.</li>
</ul>
</div>

<h2>4) Live Trading Workflow</h2>
<div class="card">
<p>The <code>logos.live</code> module stitches together feeds, brokers, risk checks, and logging so you can graduate from backtests to supervised execution.</p>
<ol>
  <li><b>Prepare the environment</b>: copy <code>.env.example</code> to <code>.env</code>, set <code>MODE=paper</code> or <code>MODE=live</code>, choose a broker (<code>BROKER=paper</code>, <code>ccxt</code>, etc.), and supply credentials as needed.</li>
  <li><b>Validate configuration</b>: run <code>python -m logos.config_validate</code> to confirm required keys, risk limits, and directory scaffolding are in place.</li>
  <li><b>Dry-run with paper broker</b>: 
    <pre><code>python -m logos.live trade --symbol BTC-USD --strategy momentum \
  --interval 1m --params '{"fast":10,"slow":30}' --risk.max-dd-bps 400 \
  --kill-switch-file /tmp/logos.kill</code></pre>
  </li>
  <li><b>Enable live orders</b> only after supervision is ready: add <code>--live</code> and <code>--i-acknowledge-risk</code>. The CLI refuses to submit if acknowledgement is missing.</li>
</ol>
<p><b>Safety controls</b> are enforced ahead of every order:</p>
<table>
  <tr><th>Control</th><th>Flag / Setting</th><th>Description</th></tr>
  <tr><td>Mode gate</td><td><code>MODE=paper|live</code></td><td>Environment variable that prevents accidental live orders.</td></tr>
  <tr><td>Acknowledgement</td><td><code>--i-acknowledge-risk</code></td><td>Required whenever <code>--live</code> is used.</td></tr>
  <tr><td>Notional limit</td><td><code>--max-notional</code> / <code>RISK_MAX_NOTIONAL</code></td><td>Caps order size in currency terms.</td></tr>
  <tr><td>Position cap</td><td><code>--risk.max-position</code> / <code>RISK_MAX_POSITION</code></td><td>Restricts net exposure.</td></tr>
  <tr><td>Drawdown breaker</td><td><code>--risk.max-dd-bps</code></td><td>Stops the loop when equity drawdown exceeds your threshold.</td></tr>
  <tr><td>Reject breaker</td><td><code>--risk.max-rejects</code></td><td>Halts after repeated broker rejections.</td></tr>
  <tr><td>Kill switch</td><td><code>--kill-switch-file</code></td><td>Touch the file from another process to shut down the runner safely.</td></tr>
</table>
<p>During every iteration the runner persists artifacts under <code>runs/live/sessions/&lt;session_id&gt;/</code>:</p>
<ul>
  <li><code>state.json</code> and <code>state.jsonl</code> track equity, positions, last bar timestamps, and structured events.</li>
  <li><code>orders.csv</code>, <code>trades.csv</code>, <code>positions.csv</code>, and <code>account.csv</code> provide auditable history for compliance or post-mortems.</li>
  <li><code>logs/run.log</code> captures per-session logging; a shared <code>logos/logs/live.log</code> streams the consolidated view.</li>
</ul>
<p><span class="note">If a session stops unexpectedly, re-run the CLI with the same parameters: the runner resumes from <code>state.json</code>, rehydrates positions, and continues once risk checks pass.</span></p>
</div>

<h2>5) Exploring Results</h2>
<div class="card">
<ul>
<li><b>Equity curve</b>: visualizes growth of simulated portfolio.</li>
<li><b>Metrics</b>: summarized in <code>metrics.json</code>; a nested <code>provenance</code> block records window, timezone, seeds, adapters, and whether synthetic data was used.</li>
<li><b>Trade log</b>: CSV with timestamps, prices, position sizes, PnL.</li>
<li><b>Provenance</b>: <code>provenance.json</code> captures the full audit trail (git SHA, CLI args, data lineage, adapters, synthetic generator metadata).</li>
<li><b>Session summary</b>: <code>session.md</code> is a human-readable digest; synthetic runs render with a banner so reviewers cannot miss the data origin.</li>
</ul>
<details>
<summary>Pro tip</summary>
<p>Pair Logos-Q1 backtests with <code>docs/MATH.html</code> to understand why each signal behaves differently in equities, crypto, or FX context.</p>
</details>
<p class="note">Set <code>LOGOS_SEED=7</code> (or any integer) before invoking CLI or live regressions when you need reproducible pseudo-random choices; provenance output now records the window bounds, timezone label, and seed together.</p>
</div>

<h2>6) Education Mode</h2>
<div class="card">
<p><b>Education mode</b> now walks you through real trading lessons using the live engine:</p>
<pre><code>python -m logos.tutor --lesson mean_reversion --plot</code></pre>
<p>This narrates each step (SMA, z-score, entries/exits, Sharpe, drawdown) and saves a transcript in <code>runs/lessons/</code>. Swap <code>--lesson</code> for <code>momentum</code> or <code>pairs_trading</code> to explore other playbooks.</p>
</div>

<h2>7) Troubleshooting</h2>
<div class="card">
<ul>
<li><b>RuntimeWarning</b>: NaN in subtract — often due to incomplete data window. Solution: ensure enough bars before indicators initialize.</li>
<li><b>Empty backtest</b>: verify <code>--start</code> / <code>--end</code> within dataset range.</li>
<li><b>Import errors</b>: re-activate venv or reinstall requirements.</li>
<li><b>Window contract errors</b>: <code>requires either --window or --start and --end</code> → provide one form; <code>inputs are mutually exclusive</code> → remove the extra flag; <code>invalid ISO duration</code> → use tokens like <code>P30D</code> or <code>P4W</code> (positive integers only).</li>
</ul>
</div>

<h2>8) Deterministic Regression Matrix</h2>
<div class="card">
<p>Phase 2 adds a deterministic regression CLI that validates translator, brokers, feeds, risk guards, and artifact writers under a fixed seed and dataset.</p>
<ul>
  <li>Dataset: <code>tests/fixtures/live/regression_default</code></li>
  <li>Seed: <code>7</code> (prepending run id <code>0007-&lt;label&gt;</code>)</li>
  <li>Clock: <code>MockTimeProvider</code> iterating minute bars (09:29Z–09:32Z)</li>
</ul>
<pre><code>python -m logos.live.regression --adapter-mode paper \
  --label regression-smoke --seed 7 \
  --dataset tests/fixtures/live/regression_default \
  --output-dir runs/live/reg_cli

python -m logos.live.regression --adapter-mode adapter --adapter ccxt \
  --label ccxt-dry-run --seed 7 \
  --dataset tests/fixtures/live/regression_default \
  --output-dir runs/live/reg_cli

python -m logos.live.regression --adapter-mode adapter --adapter alpaca \
  --label alpaca-dry-run --seed 7 \
  --dataset tests/fixtures/live/regression_default \
  --output-dir runs/live/reg_cli
</code></pre>
<p>Resulting artifacts and sha256 checksums are catalogued in <code>docs/PHASE2-ARTIFACTS.md</code>.</p>
<p>Those regression outputs follow the same provenance contract as CLI runs: expect <code>provenance.json</code>, <code>session.md</code>, and the enriched <code>metrics.json</code> under <code>runs/live/reg_cli/&lt;seed&gt;-&lt;label&gt;/</code>.</p>
</div>

<h2>9) Safety Checklist & Guard Order</h2>
<div class="card">
<ol>
  <li>Confirm <code>MODE=paper</code> (or explicit <code>--live --i-acknowledge-risk</code> combo).</li>
  <li>Run <code>python -m logos.config_validate</code> to catch misconfigurations.</li>
  <li>Provision the kill switch file and monitor <code>logos/logs/live.log</code>.</li>
  <li>Launch the runner; guards execute in this priority: notional &rsaquo; per-symbol exposure &rsaquo; drawdown &rsaquo; consecutive rejects &rsaquo; stale data &rsaquo; kill switch.</li>
  <li>Halts append structured events to <code>state.jsonl</code> and summaries to <code>session.md</code>.</li>
  <li>Restart via the same command — FIFO inventory + seed are reloaded from <code>state.json</code>.</li>
</ol>
<p>For drill scripts and advanced rehearsals, see <code>docs/LIVE-RUNBOOK.md</code>.</p>
</div>

<h2>10) QA Stack & Offline CI</h2>
<div class="card">
<pre><code>coverage run -m pytest -q
coverage report -m
ruff check .
black --check .   # formatting backlog tracked in CHANGELOG
mypy .            # install pandas-stubs + types-PyYAML first
</code></pre>
<p>The regression CLI (commands above) completes the matrix for paper, CCXT, and Alpaca dry-runs. All
commands operate offline using bundled fixtures when <code>LIVE_DISABLE_NETWORK=1</code> is set.</p>
</div>

<h2>11) Artifact Layout & Checksums</h2>
<div class="card">
<ul>
  <li>Live sessions: <code>runs/live/sessions/&lt;session_id&gt;/</code> (state, CSVs, <code>session.md</code>, logs).</li>
  <li>Regression CLI: <code>runs/live/reg_cli/0007-&lt;label&gt;/</code>.</li>
  <li>Daily trade rolls: <code>runs/live/trades/&lt;symbol&gt;_&lt;YYYYMMDD&gt;.csv</code>.</li>
  <li>Baselines: <code>tests/fixtures/regression/smoke/</code>.</li>
</ul>
<p>Verify integrity with <code>sha256sum</code>; canonical digests live in <code>docs/PHASE2-ARTIFACTS.md</code>.</p>
</div>

<h2>12) Baseline Refresh Governance</h2>
<div class="card">
<ol>
  <li>Run the regression matrix and gather diffs + adapter logs.</li>
  <li>Open a review issue; secure approval before promotion.</li>
  <li>Execute <code>python -m logos.live.regression --refresh-baseline --confirm-refresh</code> (same dataset/seed).</li>
  <li>Commit updated fixtures, refresh <code>docs/PHASE2-ARTIFACTS.md</code>, and document rationale in <code>CHANGELOG.md</code>.</li>
</ol>
</div>

<hr/>
<p>Return to <a href="index.html">🏠 Home</a> or explore <a href="SYSTEM_DESIGN.html">⚙️ System Design</a>.</p>
</div>
</body>

<script>
  const links = document.querySelectorAll('.nav a');
  links.forEach(link => {
    if (link.href === window.location.href) link.style.color = '#60a5fa';
  });
</script>


</html>
